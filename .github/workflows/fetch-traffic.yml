name: GitHub Traffic Data Collector

on:
  schedule:
    - cron: '0 * * * *'  # Saatlik √ßalƒ±≈ütƒ±rma
  workflow_dispatch:

permissions:
  contents: write  # Push yetkisi i√ßin

jobs:
  traffic-collector:
    runs-on: ubuntu-latest
    concurrency: 
      group: traffic-${{ github.ref }}
      cancel-in-progress: true

    steps:
      # 1. Temiz bir ortamda ba≈ülat
      - name: Checkout with fresh history
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          fetch-depth: 0
          clean: true

      # 2. Python ortamƒ±nƒ± kur (cache olmadan)
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'  # Cache'i kaldƒ±rmak i√ßin bu satƒ±rƒ± silin veya deƒüi≈ütirin

      # 3. Gerekli k√ºt√ºphaneleri y√ºkle
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pygithub==1.59.0
          # Cache hatasƒ±nƒ± √∂nlemek i√ßin requirements.txt olu≈ütur
          echo "pygithub==1.59.0" > requirements.txt

      # 4. Veri toplama √∂ncesi hazƒ±rlƒ±k
      - name: Prepare data environment
        run: |
          rm -rf docs/data
          mkdir -p docs/data/repos
          echo '{"repositories":[]}' > docs/data/repo-info.json
          echo "DATA_DIR=docs/data" >> $GITHUB_ENV

      # 5. Veri toplama i≈ülemi
      - name: Collect traffic data
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          python - <<EOF
          # Python script i√ßeriƒüi aynƒ± kalacak
          EOF

      # 6. Deƒüi≈üiklikleri i≈üle
      - name: Commit & Push
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add --force docs/data/
          git commit -m "üìä Traffic data snapshot $(date '+%Y-%m-%d %H:%M')" || echo "No changes"
          git pull origin main
          git push origin main --force-with-lease