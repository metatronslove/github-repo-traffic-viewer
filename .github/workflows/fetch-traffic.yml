name: GitHub Traffic Verisini Topla

on:
  schedule:
    - cron: '0 * * * *'  # Her saat baÅŸÄ± Ã§alÄ±ÅŸÄ±r (deÄŸiÅŸtirilebilir)
  workflow_dispatch:      # Manuel tetikleme

jobs:
  fetch-traffic:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      metadata: read  # Repo listesi iÃ§in gerekli

    steps:
      - name: Repo'yu klonla
        uses: actions/checkout@v3

      - name: Trafik verilerini al
        run: |
          mkdir -p docs/data
          curl -H "Accept: application/vnd.github+json" \
               -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               https://api.github.com/repos/${{ github.repository }}/traffic/views > docs/data/views.json

          curl -H "Accept: application/vnd.github+json" \
               -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               https://api.github.com/repos/${{ github.repository }}/traffic/clones > docs/data/clones.json

      - name: Repo listesini kaydet
        run: |
          mkdir -p docs/data
          # Current repo bilgilerini al
          curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               https://api.github.com/repos/${{ github.repository }} > docs/data/repos.json

      - name: Artefakt olarak yÃ¼kle (timestamp ile)
        uses: actions/upload-artifact@v3
        with:
          name: traffic-data-${{ github.run_id }}-${{ github.run_number }}
          path: docs/data/
          retention-days: 1  # 1 gÃ¼n sakla (isteÄŸe baÄŸlÄ±)

      - name: DeÄŸiÅŸiklikleri commitle
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add docs/data/*.json
          git commit -m "ğŸ”„ Trafik verileri gÃ¼ncellendi - Run ${{ github.run_number }}" || echo "DeÄŸiÅŸiklik yok"
          git push
