name: GitHub Traffic Data Collector

on:
  schedule:
    - cron: '0 * * * *'  # Saatlik Ã§alÄ±ÅŸtÄ±rma
  workflow_dispatch:

permissions:
  contents: write  # Push yetkisi iÃ§in

jobs:
  traffic-collector:
    runs-on: ubuntu-latest
    concurrency: 
      group: traffic-${{ github.ref }}
      cancel-in-progress: true

    steps:
      # 1. Temiz bir ortamda baÅŸlat
      - name: Checkout with fresh history
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          fetch-depth: 0
          clean: true

      # 2. Python ortamÄ±nÄ± kur (cache olmadan)
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'
          cache: 'pip'  # Cache'i kaldÄ±rmak iÃ§in bu satÄ±rÄ± silin veya deÄŸiÅŸtirin

      # 3. Gerekli kÃ¼tÃ¼phaneleri yÃ¼kle
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Cache hatasÄ±nÄ± Ã¶nlemek iÃ§in requirements.txt oluÅŸtur
          echo "pygithub=<1.59.0" > requirements.txt          
          python -m pip install pygithub=<1.59.0

      # 4. Veri toplama Ã¶ncesi hazÄ±rlÄ±k
      - name: Prepare data environment
        run: |
          rm -rf docs/data
          mkdir -p docs/data/repos
          echo '{"repositories":[]}' > docs/data/repo-info.json
          echo "DATA_DIR=docs/data" >> $GITHUB_ENV

      # 5. Veri toplama iÅŸlemi
      - name: Collect traffic data
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          python - <<EOF
          # Python script iÃ§eriÄŸi aynÄ± kalacak
          EOF

      # 6. DeÄŸiÅŸiklikleri iÅŸle
      - name: Commit & Push
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add --force docs/data/
          git commit -m "ğŸ“Š Traffic data snapshot $(date '+%Y-%m-%d %H:%M')" || echo "No changes"
          git pull origin main
          git push origin main --force-with-lease