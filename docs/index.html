<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Depo Trafik GÃ¶rÃ¼ntÃ¼leyici</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            color: #24292e;
        }
        h1 { color: #0366d6; }
        .chart-box {
            margin: 30px 0;
            padding: 15px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
        }
        .info-box {
            padding: 15px;
            background-color: #f6f8fa;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        #loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #586069;
        }
        .error {
            color: #cb2431;
            background-color: #ffdce0;
            padding: 10px;
            border-radius: 6px;
        }
        .repo-name {
            font-weight: 600;
            color: #0366d6;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 10px;
        }
        .pagination button {
            padding: 5px 10px;
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            cursor: pointer;
        }
        .pagination button.active {
            background: #0366d6;
            color: white;
            border-color: #0366d6;
        }
        .per-page-selector {
            margin: 10px 0;
            text-align: center;
        }
        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
        }
        .lang-btn {
            padding: 3px 8px;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            cursor: pointer;
            background: #f6f8fa;
        }
        .lang-btn.active {
            background: #0366d6;
            color: white;
        }
        .chart-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        .chart-container {
            flex: 1;
            min-width: 300px;
            position: relative;
            height: 300px;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
        .time-range-selector {
            margin: 15px 0;
            text-align: center;
        }
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 15px 0;
            padding: 12px;
            background: #f6f8fa;
            border-radius: 8px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>    
    <div class="language-switcher">
        <button class="lang-btn" onclick="changeLanguage('tr')">TR</button>
        <button class="lang-btn" onclick="changeLanguage('en')">EN</button>
    </div>    
    
    <div class="time-range-selector" id="time-range-container" style="display:none;">
        <label data-translate="timeRange">Zaman AralÄ±ÄŸÄ±:
            <select id="time-range">
                <option value="1d">Son 1 GÃ¼n</option>
                <option value="7d">Son 1 Hafta</option>
                <option value="30d" selected>Son 1 Ay</option>
                <option value="90d">Son 3 Ay</option>
                <option value="180d">Son 6 Ay</option>
                <option value="365d">Son 1 YÄ±l</option>
                <option value="all">TÃ¼m Zamanlar</option>
            </select>
        </label>
    </div>
    
    <h1 data-translate="title">GitHub Depo Trafik Verileri</h1>
    <div id="info-container"></div>
    <div id="loading">GitHub oturumunuz kontrol ediliyor...</div>
    <div class="per-page-selector" id="per-page-container" style="display:none;">
        <label>Sayfa baÅŸÄ±na depo sayÄ±sÄ±:
            <select id="per-page">
                <option value="10">10</option>
                <option value="25" selected>25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
        </label>
    </div>
    <div id="charts-container"></div>
    <div class="pagination" id="pagination" style="display:none;"></div>
    <script>
        // 1. Dil Ã§evirileri
        const translations = {
            tr: {
                title: "GitHub Depo Trafik Verileri",
                loadingAuth: "GitHub oturumunuz kontrol ediliyor...",
                loadingRepos: (loaded) => `Depo listesi alÄ±nÄ±yor (${loaded} yÃ¼klendi)...`,
                totalRepos: (count) => `Toplam depo: ${count}`,
                perPage: "Sayfa baÅŸÄ±na depo sayÄ±sÄ±:",
                pageStats: (current, total, count) => `Sayfa ${current}/${total} | Toplam ${count} depo`,
                repoHeader: (name) => `<span class="repo-name">${name}</span> deposu`,
                views: "GÃ¶rÃ¼ntÃ¼lenmeler",
                clones: "Klonlamalar",
                errorAuth: "LÃ¼tfen GitHub'da oturum aÃ§Ä±n",
                errorApiLimit: "API limiti aÅŸÄ±ldÄ±, birkaÃ§ dakika sonra tekrar deneyin",
                infoBox: `
                    <h3>ðŸš€ Kendi GitHub Trafik Verilerinizi GÃ¶rÃ¼n</h3>
                    <p>Bu sayfa sadece <strong>fork yapan kullanÄ±cÄ±nÄ±n</strong> kendi depo trafik verilerini gÃ¶sterir.</p>
                    <ol>
                        <li>SaÄŸ Ã¼stteki "Fork" butonuna basarak bu depoyu kendi hesabÄ±nÄ±za kopyalayÄ±n</li>
                        <li>GitHub Pages ayarlarÄ±ndan <code>docs</code> klasÃ¶rÃ¼nÃ¼ yayÄ±na alÄ±n</li>
                        <li>OluÅŸan sayfada <strong>kendi depo trafik verileriniz</strong> gÃ¶rÃ¼necektir</li>
                    </ol>
                `,
                previousPage: '&laquo; Ã–nceki',
                nextPage: 'Sonraki &raquo;',
                timeRange: "Zaman AralÄ±ÄŸÄ±",
                lastDay: "Son 1 GÃ¼n",
                lastWeek: "Son 1 Hafta",
                lastMonth: "Son 1 Ay",
                last3Months: "Son 3 Ay",
                last6Months: "Son 6 Ay", 
                lastYear: "Son 1 YÄ±l",
                allTime: "TÃ¼m Zamanlar"
            },
            en: {
                title: "GitHub Repository Traffic Stats",
                loadingAuth: "Checking GitHub session...",
                loadingRepos: (loaded) => `Loading repository list (${loaded} loaded)...`,
                totalRepos: (count) => `Total repositories: ${count}`,
                perPage: "Repositories per page:",
                pageStats: (current, total, count) => `Page ${current}/${total} | Total ${count} repos`,
                repoHeader: (name) => `<span class="repo-name">${name}</span> repository`,
                views: "Views",
                clones: "Clones",
                errorAuth: "Please log in to GitHub",
                errorApiLimit: "API rate limit exceeded, try again later",
                infoBox: `
                    <h3>ðŸš€ View Your GitHub Traffic Stats</h3>
                    <p>This page shows traffic stats only for the <strong>forking user's</strong> repositories.</p>
                    <ol>
                        <li>Click "Fork" button to copy this repo to your account</li>
                        <li>Enable GitHub Pages for the <code>docs</code> folder</li>
                        <li>You'll see your own repository traffic stats</li>
                    </ol>
                `,
                previousPage: '&laquo; Previous',
                nextPage: 'Next &raquo;',
                timeRange: "Time Range",
                lastDay: "Last Day",
                lastWeek: "Last Week",
                lastMonth: "Last Month",
                last3Months: "Last 3 Months",
                last6Months: "Last 6 Months",
                lastYear: "Last Year",
                allTime: "All Time"
            }
        };
        translations.tr.errorLoadingRepos = "Depo listesi yÃ¼klenemedi";
        translations.en.errorLoadingRepos = "Failed to load repository list";
        translations.tr.noData = "Veri bulunamadÄ±";
        translations.en.noData = "No data available";
        translations.tr.errorLoadingData = "Veri yÃ¼klenirken hata oluÅŸtu";
        translations.en.errorLoadingData = "Error loading data";

        let currentLang = localStorage.getItem('lang') || 'tr';
        
        // 2. TÃ¼m Ã§evirileri gÃ¼ncelleyen fonksiyon
        function updateAllTranslations() {
            // Statik metinler
            if (document.getElementById('[data-translate="title"]')) {
                document.querySelector('[data-translate="title"]').textContent = translations[currentLang].title;
            }
            if (document.getElementById('#per-page-label')) {
                document.querySelector('#per-page-label').textContent = translations[currentLang].perPage;
            }
        
            // Dinamik iÃ§erikler
            if (document.getElementById('loading')) {
                document.getElementById('loading').textContent = translations[currentLang].loadingAuth;
            }
            
            // Pagination butonlarÄ±
            const pagination = document.getElementById('pagination');
            if (pagination) {
                const prevBtn = pagination.querySelector('button:first-child');
                const nextBtn = pagination.querySelector('button:last-child');
                if (prevBtn) prevBtn.innerHTML = translations[currentLang].previousPage;
                if (nextBtn) nextBtn.innerHTML = translations[currentLang].nextPage;
            }
        }

        // 3. Dil deÄŸiÅŸtirme fonksiyonu
        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
        
            // TÃ¼m Ã§evirileri gÃ¼ncelle
            updateAllTranslations();
        
            // Grafikleri ve verileri yenile
            document.getElementById('charts-container').innerHTML = '';
            currentPage = 1;
            displayRepos();
        
            // Buton durumlarÄ±nÄ± gÃ¼ncelle
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === lang.toUpperCase());
            });
        }

        // 4. TercÃ¼meleri gÃ¼ncelle
        function updateTranslations() {
            document.querySelector('[data-translate="title"]').textContent = translations[currentLang].title;
            document.getElementById('per-page').previousSibling.textContent = translations[currentLang].perPage;
        }
        
        // 5. SayfalandÄ±rma deÄŸiÅŸkenleri
        let allRepos = [];
        let currentPage = 1;
        let reposPerPage = 25;
        let totalPages = 1;
        
        // 6. BasePath belirleme fonksiyonu
        function getBasePath() {
            // GitHub Pages iÃ§in otomatik tespit
            if (window.location.host.includes('github.io')) {
                const pathParts = window.location.pathname.split('/');
                return pathParts.slice(0, 3).join('/');
            }
            // Local development iÃ§in
            return '';
        }

        // 7. Statik JSON'dan trafik verilerini oku
        async function fetchTrafficData(repoName) {
            try {
                const basePath = getBasePath();
                
                const [viewsRes, clonesRes] = await Promise.all([
                    fetch(`${basePath}/data/repos/${encodeURIComponent(repoName)}/views.json`),
                    fetch(`${basePath}/data/repos/${encodeURIComponent(repoName)}/clones.json`)
                ]);
                
                // EÄŸer dosya bulunamazsa boÅŸ veri dÃ¶ndÃ¼r
                if (!viewsRes.ok) {
                    console.warn(`Views data not found for ${repoName}`);
                    return { views: { views: [] } };
                }
                if (!clonesRes.ok) {
                    console.warn(`Clones data not found for ${repoName}`);
                    return { clones: { clones: [] } };
                }
                
                const views = await viewsRes.json();
                const clones = await clonesRes.json();
                
                const trafficData = {
                    views: views || { views: [] },
                    clones: clones || { clones: [] }
                };
                
                if (!validateTrafficData(trafficData)) {
                    throw new Error('Invalid data structure');
                }
                
                return trafficData;
            } catch (error) {
                console.error(`Error loading traffic data for ${repoName}:`, error);
                return {
                    views: { views: [] },
                    clones: { clones: [] }
                };
            }
        }

        // 8. KullanÄ±cÄ± bilgilerini al (mock data)
        async function fetchUserData() {
            return { login: "auto-generated" };
        }

        // 9. TÃ¼m depolarÄ± al
        async function fetchAllRepos() {
            try {
                const basePath = getBasePath();
                const response = await fetch(`${basePath}/data/repo-info.json`);
                
                if (!response.ok) {
                    // Fallback: Mutlak URL deneyelim
                    const absoluteUrl = `https://${window.location.host}${basePath}/data/repo-info.json`;
                    const fallbackResponse = await fetch(absoluteUrl);
                    if (!fallbackResponse.ok) throw new Error('Repository list not found');
                    return await fallbackResponse.json();
                }
                
                const data = await response.json();
                return Array.isArray(data) ? { repositories: data } : data;
            } catch (error) {
                console.error('Error loading repositories:', error);
                showInfoBox();
                return { repositories: [] };
            }
        }

        // 10. Veri yapÄ±sÄ±nÄ± doÄŸrulamak iÃ§in yardÄ±mcÄ± fonksiyon
        function validateTrafficData(data) {
            if (!data) return false;
            if (data.views && !Array.isArray(data.views.views)) return false;
            if (data.clones && !Array.isArray(data.clones.clones)) return false;
            return true;
        }

        // 11. Tarih formatlama fonksiyonu
        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString(currentLang, {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // 12. Grafik oluÅŸturma fonksiyonu
        function createChart(canvasId, label, data, labels) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            // EÄŸer veri yoksa grafik oluÅŸturma
            if (data.length === 0) {
                ctx.parentElement.innerHTML = `<p>${translations[currentLang].noData}</p>`;
                return;
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${label} (Toplam: ${total})`,
                        data: data,
                        borderColor: '#0366d6',
                        backgroundColor: 'rgba(3, 102, 214, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { font: { size: 12 } }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Count'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // 13. Hata gÃ¶ster
        function showError(messageKey) {
            const messages = {
                'LÃ¼tfen GitHub\'da oturum aÃ§Ä±n': translations[currentLang].errorAuth,
                'API limiti aÅŸÄ±ldÄ±, birkaÃ§ dakika sonra tekrar deneyin': translations[currentLang].errorApiLimit
            };
            const message = messages[messageKey] || messageKey;
            
            const container = document.getElementById('charts-container');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        // 14. Bilgi kutusu gÃ¶ster
        function showInfoBox() {
            const info = `
                <div class="info-box">
                    ${translations[currentLang].infoBox}
                </div>
            `;
            document.getElementById('info-container').innerHTML = info;
        }

        // 15. SayfalandÄ±rma kontrollerini oluÅŸtur
        function setupPagination(totalRepos) {
            totalPages = Math.ceil(totalRepos / reposPerPage);
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Ã–nceki sayfa butonu
            const prevButton = document.createElement('button');
            prevButton.innerHTML = translations[currentLang].previousPage;
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayRepos();
                }
            });
            paginationDiv.appendChild(prevButton);
            
            // Sayfa numaralarÄ±
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                if (i === currentPage) {
                    pageButton.classList.add('active');
                }
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    displayRepos();
                });
                paginationDiv.appendChild(pageButton);
            }
            
            // Sonraki sayfa butonu
            const nextButton = document.createElement('button');
            nextButton.innerHTML = translations[currentLang].nextPage;
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayRepos();
                }
            });
            paginationDiv.appendChild(nextButton);
            
            paginationDiv.style.display = 'flex';
        }
        
        // 16. DepolarÄ± gÃ¶rÃ¼ntÃ¼le (sayfalandÄ±rmalÄ±)// 16. DepolarÄ± gÃ¶rÃ¼ntÃ¼le (sayfalandÄ±rmalÄ±)
        async function displayRepos() {
            // EÄŸer allRepos veya repositories yoksa hata gÃ¶ster
            if (!allRepos || !allRepos.repositories) {
                showError(translations[currentLang].errorLoadingRepos);
                return;
            }

            const startIdx = (currentPage - 1) * reposPerPage;
            const endIdx = startIdx + reposPerPage;
            const reposToShow = allRepos.repositories.slice(startIdx, endIdx);
    
            document.getElementById('charts-container').innerHTML = '';
            document.getElementById('loading').textContent = translations[currentLang].loadingRepos(0);
            document.getElementById('per-page-container').style.display = 'block';
            document.getElementById('time-range-container').style.display = 'block';
    
            let loadedCount = 0;
            for (const repo of reposToShow) {
                document.getElementById('loading').textContent = 
                    translations[currentLang].loadingRepos(++loadedCount);
        
                const trafficData = await fetchTrafficData(repo.name);
                const selectedRange = document.getElementById('time-range').value;
        
                // Verileri filtrele
                const filteredViews = filterDataByDateRange(trafficData.views.views, selectedRange);
                const filteredClones = filterDataByDateRange(trafficData.clones.clones, selectedRange);
        
                // Eksik tarihleri doldur
                const completeViews = fillMissingDates(filteredViews, selectedRange);
                const completeClones = fillMissingDates(filteredClones, selectedRange);
        
                const container = document.createElement('div');
                container.className = 'chart-box';
                container.innerHTML = `
                    <h3>${translations[currentLang].repoHeader(repo.name)}</h3>
                    <div class="stats-summary">
                        <div class="stat-item">
                            <span class="stat-label">${translations[currentLang].views}:</span>
                            <span class="stat-value">${trafficData.views.count || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">${translations[currentLang].clones}:</span>
                            <span class="stat-value">${trafficData.clones.count || 0}</span>
                        </div>
                    </div>
                    <div class="chart-row">
                        <div class="chart-container">
                            <canvas id="views-${repo.name}"></canvas>
                        </div>
                        <div class="chart-container">
                    <canvas id="clones-${repo.name}"></canvas>
                </div>
            </div>
            `;
            document.getElementById('charts-container').appendChild(container);

                // Views grafiÄŸi
                createChart(
                    `views-${repo.name}`,
                    translations[currentLang].views,
                    completeViews.map(v => v.count),
                    completeViews.map(v => formatDate(v.timestamp)),
                    trafficData.views.count
                );

                // Clones grafiÄŸi
                createChart(
                    `clones-${repo.name}`,
                    translations[currentLang].clones,
                    completeClones.map(c => c.count),
                    completeClones.map(c => formatDate(c.timestamp)),
                    trafficData.clones.count
                );
            }
    
            document.getElementById('pagination').style.display = 'flex';
            document.getElementById('loading').textContent = 
                translations[currentLang].pageStats(currentPage, totalPages, allRepos.repositories.length);
            setupPagination(allRepos.repositories.length);
        }
        
        // 17. YENÄ° VERÄ° FÄ°LTRELEME FONKSÄ°YONU
        function filterDataByRange(data, rangeDays) {
            if(rangeDays === 'all') return data;
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - parseInt(rangeDays));
            return data.filter(item => new Date(item.timestamp) >= cutoffDate);
        }

        // 17. Ana iÅŸlem
        async function main() {
            try {
                updateTranslations();
                
                allRepos = await fetchAllRepos();
                if (!allRepos.repositories || allRepos.repositories.length === 0) {
                    showInfoBox();
                    return;
                }
                
                // Per-page deÄŸiÅŸikliklerini dinle
                document.getElementById('per-page').addEventListener('change', (e) => {
                    reposPerPage = parseInt(e.target.value) || 25;
                    currentPage = 1; // SayfayÄ± sÄ±fÄ±rla
                    displayRepos();
                });
                
                displayRepos();
            } catch (error) {
                console.error('Main function error:', error);
                showError(translations[currentLang].errorLoadingData);
            }
        }

        // 18. Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸacak kod
        window.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === currentLang.toUpperCase());
            });
            main();
        });
    </script>
</body>
</html>